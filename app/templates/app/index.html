{% extends 'app/base.html' %}

{% block title %}MyGovernence - Request Management{% endblock %}

{% block content %}
<div class="page-content">
    <h1>MyGovernence</h1>
    
    <div class="governance-sections">
        <section class="governance-section">
            <h2 class="section-title">Notifications</h2>
            <div class="section-content">
                <!-- Content will be added here -->
            </div>
        </section>
        
        {% if can_view_triage %}
        <section class="governance-section">
            <h2 class="section-title">Triage Requests</h2>
            <div class="section-content">
                {% if triage_requests %}
                    <div class="requests-list">
                        {% for request in triage_requests %}
                            <div class="request-item" onclick="openRequestModal('{{ request.id }}', true)" data-request-id="{{ request.id }}" data-is-triage="true">
                                <div class="request-header">
                                    <h3 class="request-title">{{ request.title }}</h3>
                                    <div class="request-right-info">
                                        <span class="request-id">#{{ request.request_id }}</span>
                                        <span class="request-stage">{{ request.stage }}</span>
                                    </div>
                                </div>
                                {% if request.description %}
                                    <p class="request-description">{{ request.description|truncatewords:30 }}</p>
                                {% endif %}
                                <div class="request-meta">
                                    <span class="request-author">Created by: {{ request.created_by.get_full_name|default:request.created_by.username }}</span>
                                    <span class="request-date">{{ request.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-message">No triage requests at this time.</p>
                {% endif %}
            </div>
        </section>
        {% endif %}
        
        {% if can_view_governance %}
        <section class="governance-section">
            <h2 class="section-title">Under Review - Governance</h2>
            <div class="section-content">
                {% if governance_requests %}
                    <div class="requests-list">
                        {% for request in governance_requests %}
                            <div class="request-item" onclick="openRequestModal('{{ request.id }}', false)" data-request-id="{{ request.id }}">
                                <div class="request-header">
                                    <h3 class="request-title">{{ request.title }}</h3>
                                    <div class="request-right-info">
                                        <span class="request-id">#{{ request.request_id }}</span>
                                        <span class="request-stage">{{ request.stage }}</span>
                                    </div>
                                </div>
                                {% if request.description %}
                                    <p class="request-description">{{ request.description|truncatewords:30 }}</p>
                                {% endif %}
                                <div class="request-meta">
                                    <span class="request-author">Created by: {{ request.created_by.get_full_name|default:request.created_by.username }}</span>
                                    <span class="request-date">{{ request.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-message">No requests under governance review at this time.</p>
                {% endif %}
            </div>
        </section>
        {% endif %}
        
        <section class="governance-section">
            <h2 class="section-title">Under Review - Final Governance</h2>
            <div class="section-content">
                {% if final_governance_requests %}
                    <ul class="requests-list-format">
                        {% for request in final_governance_requests %}
                            <li class="request-list-item">
                                <div class="list-item-content">
                                    <span class="list-item-title">{{ request.title }}</span>
                                    <span class="list-item-meta">
                                        <span class="list-item-author">{{ request.created_by.get_full_name|default:request.created_by.username }}</span>
                                        <span class="list-item-date">{{ request.created_at|date:"M d, Y" }}</span>
                                    </span>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="empty-message">No requests under final governance review at this time.</p>
                {% endif %}
            </div>
        </section>
        
        <section class="governance-section">
            <h2 class="section-title">MyRequests</h2>
            <div class="section-content">
                {% if my_requests %}
                    <div class="requests-list">
                        {% for request in my_requests %}
                            <div class="request-item" onclick="openRequestModal('{{ request.id }}', false)" data-request-id="{{ request.id }}">
                                <div class="request-header">
                                    <h3 class="request-title">{{ request.title }}</h3>
                                    <div class="request-right-info">
                                        <span class="request-id">#{{ request.request_id }}</span>
                                        <span class="request-stage">{{ request.stage }}</span>
                                    </div>
                                </div>
                                {% if request.description %}
                                    <p class="request-description">{{ request.description|truncatewords:30 }}</p>
                                {% endif %}
                                <div class="request-meta">
                                    <span class="request-author">Created by: {{ request.created_by.get_full_name|default:request.created_by.username }}</span>
                                    <span class="request-date">{{ request.created_at|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="empty-message">You haven't submitted any requests yet.</p>
                {% endif %}
            </div>
        </section>
    </div>
</div>

<!-- Request Modal -->
<div id="requestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Request Details</h2>
            <span class="modal-close" onclick="closeRequestModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Modal content will be added here -->
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Confirm Delete</h2>
            <span class="modal-close" onclick="closeDeleteConfirmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to archive this request? This action cannot be undone.</p>
            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="deleteReason" style="font-weight: 600; color: #333; margin-bottom: 0.5rem; display: block;">Reason for archiving <span style="color: #dc3545;">*</span></label>
                <textarea id="deleteReason" class="form-control" rows="4" placeholder="Please provide a reason for archiving this request..." required></textarea>
                <div id="deleteReasonError" class="error-message" style="display: none; margin-top: 0.5rem;">Reason is required.</div>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem; border-top: none; padding-top: 0;">
                <div class="form-actions-right">
                    <button type="button" class="btn-secondary" onclick="closeDeleteConfirmModal()">Cancel</button>
                    <button type="button" class="btn-delete" onclick="confirmDelete()">Archive Request</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openRequestModal(requestId, isTriageRequest = false) {
        const modal = document.getElementById('requestModal');
        const modalBody = modal.querySelector('.modal-body');
        
        if (isTriageRequest) {
            // Load form for triage requests
            modalBody.innerHTML = '<div class="loading">Loading...</div>';
            const modalTitle = modal.querySelector('.modal-title');
            modal.style.display = 'block';
            
            fetch(`/edit-request/${requestId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                    if (data.form_html) {
                        modalBody.innerHTML = data.form_html;
                        if (modalTitle) {
                            modalTitle.textContent = 'Edit Request';
                        }
                        // Attach form submit handler
                        attachFormHandler();
                        // Attach file upload handler
                        attachFileUploadHandler();
                        // Update timestamps to local time
                        updateTimestampsToLocal();
                        // Update change history timestamps
                        updateChangeHistoryTimestamps();
                    }
            })
            .catch(error => {
                console.error('Error loading form:', error);
                modalBody.innerHTML = '<p class="error-message">Error loading form. Please try again.</p>';
            });
        } else {
            // Load read-only view for non-triage requests
            modalBody.innerHTML = '<div class="loading">Loading...</div>';
            const modalTitle = modal.querySelector('.modal-title');
            modal.style.display = 'block';
            
            fetch(`/view-request/${requestId}/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                if (modalTitle) {
                    modalTitle.textContent = 'Request Details';
                }
                // Update timestamps to local time for governance requests
                updateTimestampsToLocal();
                updateChangeHistoryTimestamps();
            })
            .catch(error => {
                console.error('Error loading request:', error);
                modalBody.innerHTML = '<p class="error-message">Error loading request. Please try again.</p>';
            });
        }
    }
    
    function attachFormHandler() {
        const form = document.getElementById('requestEditForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                
                fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If form_html is provided, update the modal content instead of reloading
                        if (data.form_html) {
                            const modalBody = document.querySelector('.modal-body');
                            modalBody.innerHTML = data.form_html;
                            // Re-attach handlers
                            attachFormHandler();
                            attachFileUploadHandler();
                            updateTimestampsToLocal();
                        } else {
                            // Reload page to show updated data
                            window.location.reload();
                        }
                    } else {
                        // Show errors
                        const modalBody = document.querySelector('.modal-body');
                        if (data.errors) {
                            // Display form errors
                            alert('Please correct the errors in the form.');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error submitting form:', error);
                    alert('Error saving changes. Please try again.');
                });
            });
        }
    }
    
    function attachFileUploadHandler() {
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const attachmentsList = document.getElementById('attachmentsList');
        
        if (!fileUploadArea || !fileInput) return;
        
        const requestId = fileUploadArea.getAttribute('data-request-id');
        
        // Click to browse
        fileUploadArea.addEventListener('click', function(e) {
            // Don't trigger if clicking on attachment items or links
            if (!e.target.closest('.attachment-item') && !e.target.closest('.attachment-link')) {
                fileInput.click();
            }
        });
        
        // File input change
        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files, requestId, attachmentsList);
            // Clear the input so the same file can be uploaded again if needed
            fileInput.value = '';
        });
        
        // Drag and drop
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.add('drag-over');
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('drag-over');
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files, requestId, attachmentsList);
            }
        });
    }
    
    function handleFiles(files, requestId, attachmentsList) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const MAX_FILES = 5;
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes
        
        // Check current attachment count
        const currentAttachments = attachmentsList.querySelectorAll('.attachment-item').length;
        const filesArray = Array.from(files);
        
        // Check total file count
        if (currentAttachments + filesArray.length > MAX_FILES) {
            alert(`You can only upload up to ${MAX_FILES} files total. You currently have ${currentAttachments} file(s).`);
            return;
        }
        
        // Check file sizes
        const oversizedFiles = filesArray.filter(file => file.size > MAX_FILE_SIZE);
        if (oversizedFiles.length > 0) {
            const fileNames = oversizedFiles.map(f => f.name).join(', ');
            alert(`The following file(s) exceed the 10MB limit: ${fileNames}`);
            return;
        }
        
        filesArray.forEach(file => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            fetch(`/upload-attachment/${requestId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addAttachmentToList(data.attachment, attachmentsList);
                } else {
                    alert('Error uploading file: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error uploading file:', error);
                alert('Error uploading file. Please try again.');
            });
        });
    }
    
    function addAttachmentToList(attachment, attachmentsList) {
        // Remove "no attachments" message if it exists
        const noAttachmentsMsg = attachmentsList.querySelector('.no-attachments-message');
        if (noAttachmentsMsg) {
            noAttachmentsMsg.remove();
        }
        
        const attachmentItem = document.createElement('div');
        attachmentItem.className = 'attachment-item';
        attachmentItem.setAttribute('data-attachment-id', attachment.id);
        attachmentItem.innerHTML = `
            <span class="attachment-name">${escapeHtml(attachment.filename)}</span>
            <div class="attachment-actions">
                <a href="${attachment.url}" target="_blank" class="attachment-link">View</a>
                <button type="button" class="attachment-delete" onclick="deleteAttachment(${attachment.id})">Delete</button>
            </div>
        `;
        attachmentsList.appendChild(attachmentItem);
    }
    
    function deleteAttachment(attachmentId) {
        if (!confirm('Are you sure you want to delete this attachment?')) {
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        fetch(`/delete-attachment/${attachmentId}/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const attachmentsList = document.getElementById('attachmentsList');
                const attachmentItem = attachmentsList.querySelector(`[data-attachment-id="${attachmentId}"]`);
                if (attachmentItem) {
                    attachmentItem.remove();
                    
                    // Show "no attachments" message if list is empty
                    if (attachmentsList.querySelectorAll('.attachment-item').length === 0) {
                        const noAttachmentsMsg = document.createElement('p');
                        noAttachmentsMsg.className = 'no-attachments-message';
                        noAttachmentsMsg.textContent = 'No attachments uploaded yet.';
                        attachmentsList.appendChild(noAttachmentsMsg);
                    }
                }
            } else {
                alert('Error deleting attachment: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting attachment:', error);
            alert('Error deleting attachment. Please try again.');
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function updateTimestampsToLocal() {
        // Update all history timestamps to local time
        const timestamps = document.querySelectorAll('.history-timestamp[data-utc]');
        timestamps.forEach(timestamp => {
            const utcString = timestamp.getAttribute('data-utc');
            if (utcString) {
                const date = new Date(utcString);
                const localString = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                timestamp.textContent = localString;
            }
        });
    }
    
    function updateChangeHistoryTimestamps() {
        // Update all change history timestamps to local time
        const timestamps = document.querySelectorAll('.change-timestamp[data-utc]');
        timestamps.forEach(timestamp => {
            const utcString = timestamp.getAttribute('data-utc');
            if (utcString) {
                const date = new Date(utcString);
                const localString = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                timestamp.textContent = localString;
            }
        });
    }
    
    function closeRequestModal() {
        const modal = document.getElementById('requestModal');
        modal.style.display = 'none';
    }
    
    let currentDeleteRequestId = null;
    
    function showDeleteConfirmation(requestId) {
        currentDeleteRequestId = requestId;
        const modal = document.getElementById('deleteConfirmModal');
        const reasonInput = document.getElementById('deleteReason');
        const errorDiv = document.getElementById('deleteReasonError');
        
        // Reset form
        reasonInput.value = '';
        errorDiv.style.display = 'none';
        reasonInput.classList.remove('error');
        
        modal.style.display = 'block';
    }
    
    function closeDeleteConfirmModal() {
        const modal = document.getElementById('deleteConfirmModal');
        modal.style.display = 'none';
        currentDeleteRequestId = null;
    }
    
    function confirmDelete() {
        const reasonInput = document.getElementById('deleteReason');
        const errorDiv = document.getElementById('deleteReasonError');
        const reason = reasonInput.value.trim();
        
        // Validate reason
        if (!reason) {
            errorDiv.style.display = 'block';
            reasonInput.classList.add('error');
            reasonInput.focus();
            return;
        }
        
        // Disable button to prevent double submission
        const confirmBtn = event.target;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Archiving...';
        
        // Send delete request
        fetch(`/archive-request/${currentDeleteRequestId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                reason: reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modals and reload page or update UI
                closeDeleteConfirmModal();
                closeRequestModal();
                // Reload the page to reflect changes
                window.location.reload();
            } else {
                alert('Error archiving request: ' + (data.error || 'Unknown error'));
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Archive Request';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error archiving request. Please try again.');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Archive Request';
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Close delete confirmation modal when clicking outside
    document.addEventListener('click', function(event) {
        const deleteModal = document.getElementById('deleteConfirmModal');
        const requestModal = document.getElementById('requestModal');
        if (event.target === deleteModal) {
            closeDeleteConfirmModal();
        }
        if (event.target === requestModal) {
            closeRequestModal();
        }
    });
    
    // Close modal when clicking outside of it
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('requestModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}

